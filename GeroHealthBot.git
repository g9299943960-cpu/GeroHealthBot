#!/usr/bin/env python3
# -*- coding: utf-8 -*-

"""
GeroHealthBot ‚Äî –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π –¥–Ω–µ–≤–Ω–∏–∫ –∑–¥–æ—Ä–æ–≤—å—è.
–í–µ—Ä—Å–∏—è 1.0, –ø–æ–ª–Ω–æ—Å—Ç—å—é —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –¢–ó.
"""

import json
import os
import logging
from datetime import datetime, timedelta
from collections import defaultdict
from typing import Dict, List, Tuple, Optional
from telegram import (
    Update, InlineKeyboardButton, InlineKeyboardMarkup,
    ReplyKeyboardMarkup, KeyboardButton, ReplyKeyboardRemove
)
from telegram.ext import (
    Application, CommandHandler, MessageHandler,
    CallbackQueryHandler, ConversationHandler,
    ContextTypes, filters
)
from telegram.constants import ParseMode

# ================ –ù–ê–°–¢–†–û–ô–ö–ò ================
TOKEN = "8385277631:AAHfThc38rV5ek7PWs2i3TRU8eeGgfKeW6E"          # ‚Üê –≤—Å—Ç–∞–≤—å —Å—é–¥–∞ —Ç–æ–∫–µ–Ω –æ—Ç @BotFather
DATA_FILE = "health_data.json"          # —Ñ–∞–π–ª —Å –¥–∞–Ω–Ω—ã–º–∏
CHECKIN_TIME = "21:00"                 # –≤—Ä–µ–º—è –≤–µ—á–µ—Ä–Ω–µ–≥–æ —á–µ–∫-–∏–Ω–∞
TIMEZONE_OFFSET = 3                   # UTC+3 (–ú–æ—Å–∫–≤–∞), –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –ø–æ–ø—Ä–∞–≤—å

# ================ –õ–û–ì–ò–†–û–í–ê–ù–ò–ï ================
logging.basicConfig(
    format="%(asctime)s - %(name)s - %(levelname)s - %(message)s",
    level=logging.INFO
)
logger = logging.getLogger(__name__)

# ================ –°–û–°–¢–û–Ø–ù–ò–Ø –î–õ–Ø –î–ò–ê–õ–û–ì–û–í ================
(
    STATE_HERPES_LOCATION,
    STATE_HERPES_INTENSITY,
    STATE_HERPES_TRIGGER,
    STATE_HERPES_NOTES,
    STATE_PRECURSOR_DESC,
    STATE_MED_NAME,
    STATE_MED_DOSE,
    STATE_ANALYSIS_TEXT,
    STATE_REMINDER_SET
) = range(9)

# ================ –†–ê–ë–û–¢–ê –° JSON-–ë–ê–ó–û–ô ================
def load_data() -> dict:
    """–ó–∞–≥—Ä—É–∂–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ –∏–∑ JSON-—Ñ–∞–π–ª–∞. –ï—Å–ª–∏ —Ñ–∞–π–ª–∞ –Ω–µ—Ç ‚Äî —Å–æ–∑–¥–∞—ë—Ç —Å—Ç—Ä—É–∫—Ç—É—Ä—É."""
    if os.path.exists(DATA_FILE):
        with open(DATA_FILE, "r", encoding="utf-8") as f:
            return json.load(f)
    else:
        # –°—Ç–∞—Ä—Ç–æ–≤–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–∞–Ω–Ω—ã—Ö
        return {
            "users": {},           # user_id: {"name": ..., "registered": "–¥–∞—Ç–∞", "reminders": []}
            "symptoms": [],        # –µ–∂–µ–¥–Ω–µ–≤–Ω—ã–µ —á–µ–∫-–∏–Ω—ã
            "herpes": [],         # —Ä–µ—Ü–∏–¥–∏–≤—ã –≥–µ—Ä–ø–µ—Å–∞
            "precursors": [],     # –ø—Ä–µ–¥–≤–µ—Å—Ç–Ω–∏–∫–∏
            "medications": [],    # –ø—Ä–∏—ë–º –ª–µ–∫–∞—Ä—Å—Ç–≤
            "triggers": [],       # —Ç—Ä–∏–≥–≥–µ—Ä—ã
            "analyses": []       # –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–µ –∞–Ω–∞–ª–∏–∑—ã
        }

def save_data(data: dict):
    """–°–æ—Ö—Ä–∞–Ω—è–µ—Ç –¥–∞–Ω–Ω—ã–µ –≤ JSON-—Ñ–∞–π–ª."""
    with open(DATA_FILE, "w", encoding="utf-8") as f:
        json.dump(data, f, ensure_ascii=False, indent=2)

# ================ –†–ï–ì–ò–°–¢–†–ê–¶–ò–Ø –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Ø ================
async def start(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user = update.effective_user
    user_id = str(user.id)
    data = load_data()
    
    # –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –µ—â—ë –Ω–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω ‚Äî –¥–æ–±–∞–≤–∏–º
    if user_id not in data["users"]:
        data["users"][user_id] = {
            "name": user.full_name,
            "registered": datetime.now().isoformat(),
            "reminders": []          # —Å–ø–∏—Å–æ–∫ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π: {"time": "08:00", "med": "–≤–∞–ª–∞—Ü–∏–∫–ª–æ–≤–∏—Ä"}
        }
        save_data(data)
    
    welcome = (
        f"ü©∫ –ó–¥—Ä–∞–≤—Å—Ç–≤—É–π, {user.first_name}!\n"
        "–Ø ‚Äî GeroHealthBot, —Ç–≤–æ–π –ª–∏—á–Ω—ã–π –¥–Ω–µ–≤–Ω–∏–∫ –∑–¥–æ—Ä–æ–≤—å—è.\n\n"
        "üìå *–û—Å–Ω–æ–≤–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:*\n"
        "/–≥–µ—Ä–ø–µ—Å ‚Äî –∑–∞–ø–∏—Å–∞—Ç—å —Ä–µ—Ü–∏–¥–∏–≤\n"
        "/–ø—Ä–µ–¥ ‚Äî –ø—Ä–µ–¥–≤–µ—Å—Ç–Ω–∏–∫ (–ø–æ–∫–∞–ª—ã–≤–∞–Ω–∏–µ, –∑—É–¥)\n"
        "/–±–æ–ª—å [0-10] ‚Äî –±—ã—Å—Ç—Ä–æ –æ—Ü–µ–Ω–∏—Ç—å –±–æ–ª—å –≤ –∫–æ–ø—á–∏–∫–µ\n"
        "/–º–æ–∑–≥ ‚Äî –∫–æ–≥–Ω–∏—Ç–∏–≤–Ω—ã–µ —Å–∏–º–ø—Ç–æ–º—ã (—Ç—É–º–∞–Ω, –∑–∞–±—ã–≤—á–∏–≤–æ—Å—Ç—å)\n"
        "/—Ç—Ä–∏–≥–≥–µ—Ä ‚Äî –¥–æ–±–∞–≤–∏—Ç—å —Ç—Ä–∏–≥–≥–µ—Ä\n"
        "/–ª–µ–∫–∞—Ä—Å—Ç–≤–æ ‚Äî –æ—Ç–º–µ—Ç–∏—Ç—å –ø—Ä–∏—ë–º –ø—Ä–µ–ø–∞—Ä–∞—Ç–∞\n"
        "/–∞–Ω–∞–ª–∏–∑ ‚Äî –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç –∞–Ω–∞–ª–∏–∑–∞\n"
        "/–æ—Ç—á—ë—Ç ‚Äî —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∑–∞ –Ω–µ–¥–µ–ª—é/–º–µ—Å—è—Ü\n"
        "/–Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ ‚Äî –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è –æ –ª–µ–∫–∞—Ä—Å—Ç–≤–∞—Ö\n\n"
        "üåô –ö–∞–∂–¥—ã–π –≤–µ—á–µ—Ä –≤ 21:00 —è –±—É–¥—É –ø—Ä–∏—Å—ã–ª–∞—Ç—å —á–µ–∫-–∏–Ω.\n"
        "–ï—Å–ª–∏ —á—Ç–æ-—Ç–æ –Ω–µ–ø–æ–Ω—è—Ç–Ω–æ ‚Äî –∂–º–∏ /help"
    )
    await update.message.reply_text(welcome, parse_mode=ParseMode.MARKDOWN)

async def help_command(update: Update, context: ContextTypes.DEFAULT_TYPE):
    text = (
        "üÜò *–ü–æ–º–æ—â—å –ø–æ –∫–æ–º–∞–Ω–¥–∞–º*\n\n"
        "üî∏ `/–≥–µ—Ä–ø–µ—Å` ‚Äî –ø–æ—à–∞–≥–æ–≤–æ –∑–∞–ø–∏—Å–∞—Ç—å —Ä–µ—Ü–∏–¥–∏–≤: –ª–æ–∫–∞—Ü–∏—è, —Å–∏–ª–∞, —Ç—Ä–∏–≥–≥–µ—Ä, –ø—Ä–∏–º–µ—á–∞–Ω–∏—è.\n"
        "üî∏ `/–ø—Ä–µ–¥` ‚Äî –æ—Ç–º–µ—Ç–∏—Ç—å –ø—Ä–µ–¥–≤–µ—Å—Ç–Ω–∏–∫, –±–æ—Ç –ø—Ä–µ–¥–ª–æ–∂–∏—Ç –Ω–∞—á–∞—Ç—å –ø—É–ª—å—Å-—Ç–µ—Ä–∞–ø–∏—é.\n"
        "üî∏ `/–±–æ–ª—å 5` ‚Äî –º–≥–Ω–æ–≤–µ–Ω–Ω–∞—è –æ—Ü–µ–Ω–∫–∞ –±–æ–ª–∏ (0‚Äì10).\n"
        "üî∏ `/–º–æ–∑–≥` ‚Äî –≤—ã–±—Ä–∞—Ç—å –∫–æ–≥–Ω–∏—Ç–∏–≤–Ω—ã–µ —Å–∏–º–ø—Ç–æ–º—ã –∏ –∏—Ö –∏–Ω—Ç–µ–Ω—Å–∏–≤–Ω–æ—Å—Ç—å.\n"
        "üî∏ `/—Ç—Ä–∏–≥–≥–µ—Ä` ‚Äî –¥–æ–±–∞–≤–∏—Ç—å —Ç—Ä–∏–≥–≥–µ—Ä–Ω—ã–π —Ñ–∞–∫—Ç–æ—Ä (—Å—Ç—Ä–µ—Å—Å, –µ–¥–∞ –∏ —Ç.–¥.).\n"
        "üî∏ `/–ª–µ–∫–∞—Ä—Å—Ç–≤–æ` ‚Äî –∑–∞–ø–∏—Å–∞—Ç—å –ø—Ä–∏—ë–º –ø—Ä–µ–ø–∞—Ä–∞—Ç–∞.\n"
        "üî∏ `/–∞–Ω–∞–ª–∏–∑` ‚Äî –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ç–µ–∫—Å—Ç –∏–ª–∏ —Ñ–æ—Ç–æ –∞–Ω–∞–ª–∏–∑–∞.\n"
        "üî∏ `/–æ—Ç—á—ë—Ç –Ω–µ–¥–µ–ª—è` –∏–ª–∏ `/–æ—Ç—á—ë—Ç –º–µ—Å—è—Ü` ‚Äî —Å–≤–æ–¥–∫–∞ –¥–ª—è –≤—Ä–∞—á–∞.\n"
        "üî∏ `/–Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ` ‚Äî —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å/—É–¥–∞–ª–∏—Ç—å –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è.\n"
        "üî∏ `/cancel` ‚Äî –æ—Ç–º–µ–Ω–∏—Ç—å —Ç–µ–∫—É—â–∏–π –¥–∏–∞–ª–æ–≥.\n\n"
        "–î–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤ JSON. –î–ª—è —Å–±—Ä–æ—Å–∞ –≤—Å–µ—Ö –¥–∞–Ω–Ω—ã—Ö —É–¥–∞–ª–∏ —Ñ–∞–π–ª health_data.json."
    )
    await update.message.reply_text(text, parse_mode=ParseMode.MARKDOWN)

# ================ –ö–û–ú–ê–ù–î–ê /–ì–ï–†–ü–ï–° (–¥–∏–∞–ª–æ–≥) ================
async def herpes_start(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–ù–∞—á–∞–ª–æ –∑–∞–ø–∏—Å–∏ —Ä–µ—Ü–∏–¥–∏–≤–∞: –≤—ã–±–æ—Ä –ª–æ–∫–∞—Ü–∏–∏."""
    keyboard = [
        [InlineKeyboardButton("üëÑ –ì—É–±–∞", callback_data="loc_lip")],
        [InlineKeyboardButton("üëÉ –ù–æ—Å", callback_data="loc_nose")],
        [InlineKeyboardButton("üëÅ –ì–ª–∞–∑", callback_data="loc_eye")],
        [InlineKeyboardButton("ü©≤ –ì–µ–Ω–∏—Ç–∞–ª—å–Ω–æ", callback_data="loc_genital")],
        [InlineKeyboardButton("ü¶¥ –ö–æ–ø—á–∏–∫", callback_data="loc_coccyx")],
        [InlineKeyboardButton("‚ùå –û—Ç–º–µ–Ω–∞", callback_data="cancel")]
    ]
    reply_markup = InlineKeyboardMarkup(keyboard)
    await update.message.reply_text(
        "üìç –ì–¥–µ –ø–æ—è–≤–∏–ª—Å—è –≥–µ—Ä–ø–µ—Å?",
        reply_markup=reply_markup
    )
    return STATE_HERPES_LOCATION

async def herpes_location(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—ã–±–æ—Ä–∞ –ª–æ–∫–∞—Ü–∏–∏."""
    query = update.callback_query
    await query.answer()
    
    if query.data == "cancel":
        await query.edit_message_text("‚ùå –ó–∞–ø–∏—Å—å –æ—Ç–º–µ–Ω–µ–Ω–∞.")
        return ConversationHandler.END
    
    # –°–æ—Ö—Ä–∞–Ω—è–µ–º –ª–æ–∫–∞—Ü–∏—é
    loc_map = {
        "loc_lip": "–≥—É–±–∞", "loc_nose": "–Ω–æ—Å", "loc_eye": "–≥–ª–∞–∑",
        "loc_genital": "–≥–µ–Ω–∏—Ç–∞–ª—å–Ω–æ", "loc_coccyx": "–∫–æ–ø—á–∏–∫"
    }
    context.user_data["herpes_location"] = loc_map.get(query.data, "–¥—Ä—É–≥–æ–µ")
    
    # –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –∏–Ω—Ç–µ–Ω—Å–∏–≤–Ω–æ—Å—Ç—å
    keyboard = [
        [InlineKeyboardButton("1 ‚Äî —Å–ª–∞–±–æ", callback_data="int_1")],
        [InlineKeyboardButton("2 ‚Äî —Å—Ä–µ–¥–Ω–µ", callback_data="int_2")],
        [InlineKeyboardButton("3 ‚Äî —Å–∏–ª—å–Ω–æ", callback_data="int_3")]
    ]
    reply_markup = InlineKeyboardMarkup(keyboard)
    await query.edit_message_text(
        f"–õ–æ–∫–∞—Ü–∏—è: {context.user_data['herpes_location']}\n"
        "‚ö° –û—Ü–µ–Ω–∏ –∏–Ω—Ç–µ–Ω—Å–∏–≤–Ω–æ—Å—Ç—å:",
        reply_markup=reply_markup
    )
    return STATE_HERPES_INTENSITY

async def herpes_intensity(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–û–±—Ä–∞–±–æ—Ç–∫–∞ –∏–Ω—Ç–µ–Ω—Å–∏–≤–Ω–æ—Å—Ç–∏."""
    query = update.callback_query
    await query.answer()
    
    if query.data == "cancel":
        await query.edit_message_text("‚ùå –û—Ç–º–µ–Ω–µ–Ω–æ.")
        return ConversationHandler.END
    
    intensity = int(query.data.split("_")[1])
    context.user_data["herpes_intensity"] = intensity
    
    # –°–ø—Ä–∞—à–∏–≤–∞–µ–º —Ç—Ä–∏–≥–≥–µ—Ä
    keyboard = [
        [InlineKeyboardButton("üò∞ –°—Ç—Ä–µ—Å—Å", callback_data="trig_stress")],
        [InlineKeyboardButton("üçî –ï–¥–∞", callback_data="trig_food")],
        [InlineKeyboardButton("üî• –ü–µ—Ä–µ–≥—Ä–µ–≤", callback_data="trig_overheat")],
        [InlineKeyboardButton("üåô –ú–µ–Ω—Å—Ç—Ä—É–∞—Ü–∏—è", callback_data="trig_menstruation")],
        [InlineKeyboardButton("ü§ß –û–†–í–ò", callback_data="trig_cold")],
        [InlineKeyboardButton("üí§ –ù–µ–¥–æ—Å—ã–ø", callback_data="trig_sleep")],
        [InlineKeyboardButton("‚ùì –î—Ä—É–≥–æ–µ", callback_data="trig_other")],
        [InlineKeyboardButton("‚û° –ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å", callback_data="skip")]
    ]
    reply_markup = InlineKeyboardMarkup(keyboard)
    await query.edit_message_text(
        "üéØ –ß—Ç–æ –º–æ–≥–ª–æ —Å–ø—Ä–æ–≤–æ—Ü–∏—Ä–æ–≤–∞—Ç—å —Ä–µ—Ü–∏–¥–∏–≤?",
        reply_markup=reply_markup
    )
    return STATE_HERPES_TRIGGER

async def herpes_trigger(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–û–±—Ä–∞–±–æ—Ç–∫–∞ —Ç—Ä–∏–≥–≥–µ—Ä–∞."""
    query = update.callback_query
    await query.answer()
    
    if query.data == "cancel":
        await query.edit_message_text("‚ùå –û—Ç–º–µ–Ω–µ–Ω–æ.")
        return ConversationHandler.END
    
    trig_map = {
        "trig_stress": "—Å—Ç—Ä–µ—Å—Å", "trig_food": "–µ–¥–∞", "trig_overheat": "–ø–µ—Ä–µ–≥—Ä–µ–≤",
        "trig_menstruation": "–º–µ–Ω—Å—Ç—Ä—É–∞—Ü–∏—è", "trig_cold": "–û–†–í–ò",
        "trig_sleep": "–Ω–µ–¥–æ—Å—ã–ø", "trig_other": "–¥—Ä—É–≥–æ–µ"
    }
    trigger = trig_map.get(query.data, "–¥—Ä—É–≥–æ–µ") if query.data != "skip" else None
    context.user_data["herpes_trigger"] = trigger
    
    # –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –∑–∞–º–µ—Ç–∫–∏ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
    await query.edit_message_text(
        "üìù –î–æ–±–∞–≤—å –∑–∞–º–µ—Ç–∫—É (–Ω–∞–ø—Ä–∏–º–µ—Ä, —Ä–∞–∑–º–µ—Ä –≤—ã—Å—ã–ø–∞–Ω–∏–π, –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Å–∏–º–ø—Ç–æ–º—ã).\n"
        "–ò–ª–∏ –æ—Ç–ø—Ä–∞–≤—å /skip —á—Ç–æ–±—ã –ø—Ä–æ–ø—É—Å—Ç–∏—Ç—å."
    )
    return STATE_HERPES_NOTES

async def herpes_notes(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∑–∞–º–µ—Ç–æ–∫ –∏ –∑–∞–ø–∏—Å—å –≤ –ë–î."""
    notes = update.message.text.strip()
    await _save_herpes_entry(update, context, notes)
    return ConversationHandler.END

async def herpes_notes_skip(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–ü—Ä–æ–ø—É—Å–∫ –∑–∞–º–µ—Ç–æ–∫."""
    await _save_herpes_entry(update, context, "")
    return ConversationHandler.END

async def _save_herpes_entry(update: Update, context: ContextTypes.DEFAULT_TYPE, notes: str):
    """–û–±—â–∞—è —Ñ—É–Ω–∫—Ü–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∑–∞–ø–∏—Å–∏ –æ –≥–µ—Ä–ø–µ—Å–µ."""
    user_id = str(update.effective_user.id)
    data = load_data()
    
    entry = {
        "user_id": user_id,
        "date": datetime.now().isoformat(),
        "location": context.user_data.get("herpes_location", "–Ω–µ —É–∫–∞–∑–∞–Ω–æ"),
        "intensity": context.user_data.get("herpes_intensity", 1),
        "trigger": context.user_data.get("herpes_trigger"),
        "notes": notes,
        "pulse_therapy": False   # –ø–æ–∑–∂–µ –º–æ–∂–µ—Ç –±—ã—Ç—å —Å–≤—è–∑–∞–Ω–æ —Å /–ø—Ä–µ–¥
    }
    data["herpes"].append(entry)
    save_data(data)
    
    await update.message.reply_text(
        f"‚úÖ –†–µ—Ü–∏–¥–∏–≤ –∑–∞–ø–∏—Å–∞–Ω:\n"
        f"üìç {entry['location']}, –∏–Ω—Ç–µ–Ω—Å–∏–≤–Ω–æ—Å—Ç—å {entry['intensity']}/3\n"
        f"üéØ –¢—Ä–∏–≥–≥–µ—Ä: {entry['trigger'] if entry['trigger'] else '–Ω–µ —É–∫–∞–∑–∞–Ω'}"
    )
    context.user_data.clear()

# ================ –ö–û–ú–ê–ù–î–ê /–ü–†–ï–î (–ü–†–ï–î–í–ï–°–¢–ù–ò–ö) ================
async def precursor_start(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–ó–∞–ø–∏—Å—å –ø—Ä–µ–¥–≤–µ—Å—Ç–Ω–∏–∫–∞ + –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ –ø—É–ª—å—Å-—Ç–µ—Ä–∞–ø–∏–∏."""
    await update.message.reply_text(
        "üëÄ –û–ø–∏—à–∏ –ø—Ä–µ–¥–≤–µ—Å—Ç–Ω–∏–∫ (–ø–æ–∫–∞–ª—ã–≤–∞–Ω–∏–µ, –∑—É–¥, –∂–∂–µ–Ω–∏–µ –∏ —Ç.–¥.):"
    )
    return STATE_PRECURSOR_DESC

async def precursor_desc(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–°–æ—Ö—Ä–∞–Ω—è–µ–º –æ–ø–∏—Å–∞–Ω–∏–µ, —Å–ø—Ä–∞—à–∏–≤–∞–µ–º –ø—Ä–æ –ø—É–ª—å—Å-—Ç–µ—Ä–∞–ø–∏—é."""
    desc = update.message.text.strip()
    context.user_data["precursor_desc"] = desc
    
    keyboard = [
        [InlineKeyboardButton("‚úÖ –î–∞, –Ω–∞—á–∞—Ç—å", callback_data="pulse_yes")],
        [InlineKeyboardButton("‚ùå –ù–µ—Ç", callback_data="pulse_no")]
    ]
    reply_markup = InlineKeyboardMarkup(keyboard)
    await update.message.reply_text(
        "üíä –ù–∞—á–∏–Ω–∞–µ–º –ø—É–ª—å—Å-—Ç–µ—Ä–∞–ø–∏—é?",
        reply_markup=reply_markup
    )
    return STATE_PRECURSOR_DESC  # –æ—Å—Ç–∞—ë–º—Å—è –≤ —Ç–æ–º –∂–µ —Å–æ—Å—Ç–æ—è–Ω–∏–∏ –¥–ª—è –∫–æ–ª–±—ç–∫–∞

async def precursor_callback(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ç–≤–µ—Ç–∞ –Ω–∞ –ø—É–ª—å—Å-—Ç–µ—Ä–∞–ø–∏—é."""
    query = update.callback_query
    await query.answer()
    
    user_id = str(update.effective_user.id)
    data = load_data()
    
    # –ó–∞–ø–∏—Å—å –ø—Ä–µ–¥–≤–µ—Å—Ç–Ω–∏–∫–∞
    precursor_entry = {
        "user_id": user_id,
        "date": datetime.now().isoformat(),
        "description": context.user_data.get("precursor_desc", ""),
        "pulse_started": query.data == "pulse_yes"
    }
    data["precursors"].append(precursor_entry)
    
    if query.data == "pulse_yes":
        # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å—Ö–µ–º—É –ø—É–ª—å—Å-—Ç–µ—Ä–∞–ø–∏–∏
        scheme = (
            "üõ° *–°—Ö–µ–º–∞ –ø—É–ª—å—Å-—Ç–µ—Ä–∞–ø–∏–∏*\n\n"
            "‚Ä¢ –¢–∏–ª–æ—Ä–æ–Ω 125 –º–≥ ‚Äî 1 —Ç–∞–± –æ–¥–Ω–æ–∫—Ä–∞—Ç–Ω–æ\n"
            "‚Ä¢ –í–∞–ª–∞—Ü–∏–∫–ª–æ–≤–∏—Ä 1 –≥ —Ö 2 —Ä/–¥ ‚Äì 3‚Äì4 –¥–Ω—è, –∑–∞—Ç–µ–º 500 –º–≥ —Ö 3 —Ä/–¥ ‚Äì 7 –¥–Ω–µ–π\n"
            "‚Ä¢ –ú–æ–Ω–æ–ª–∞—É—Ä–∏–Ω 500 –º–≥ —Ö 2 —Ä/–¥ ‚Äì 10 –¥–Ω–µ–π\n\n"
            "–ù–∞—á–∞–ª–æ –∑–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–æ. –ß–µ—Ä–µ–∑ 3 –¥–Ω—è –ø—Ä–æ–≤–µ—Ä—å —Å–æ—Å—Ç–æ—è–Ω–∏–µ."
        )
        await query.edit_message_text(
            scheme,
            parse_mode=ParseMode.MARKDOWN
        )
        # –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ –Ω–∞ –∑–∞–≤—Ç—Ä–∞ (—á–µ—Ä–µ–∑ JobQueue)
        # context.job_queue.run_once(reminder_check, when=timedelta(days=1), user_id=user_id)
    else:
        await query.edit_message_text("‚ùå –ü—É–ª—å—Å-—Ç–µ—Ä–∞–ø–∏—è –Ω–µ –Ω–∞—á–∞—Ç–∞.")
    
    save_data(data)
    context.user_data.clear()
    return ConversationHandler.END

# ================ –ë–´–°–¢–†–´–ï –ö–û–ú–ê–ù–î–´ ================
async def quick_pain(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–ö–æ–º–∞–Ω–¥–∞ /–±–æ–ª—å [0-10]."""
    try:
        args = context.args
        if not args:
            await update.message.reply_text("‚ùì –£–∫–∞–∂–∏ –∑–Ω–∞—á–µ–Ω–∏–µ: /–±–æ–ª—å 5")
            return
        level = int(args[0])
        if level < 0 or level > 10:
            raise ValueError
    except:
        await update.message.reply_text("‚ùì –ò—Å–ø–æ–ª—å–∑—É–π —á–∏—Å–ª–æ –æ—Ç 0 –¥–æ 10.")
        return
    
    user_id = str(update.effective_user.id)
    data = load_data()
    
    # –°–æ—Ö—Ä–∞–Ω—è–µ–º –∫–∞–∫ –∑–∞–ø–∏—Å—å –æ –±–æ–ª–∏ (–º–æ–∂–Ω–æ –≤ symptoms, –Ω–æ —É–ø—Ä–æ—Å—Ç–∏–º)
    entry = {
        "user_id": user_id,
        "date": datetime.now().isoformat(),
        "type": "pain",
        "value": level,
        "notes": "–±—ã—Å—Ç—Ä–∞—è –∑–∞–ø–∏—Å—å"
    }
    # –ú–æ–∂–Ω–æ —Ö—Ä–∞–Ω–∏—Ç—å –≤ –æ—Ç–¥–µ–ª—å–Ω–æ–º —Å–ø–∏—Å–∫–µ –∏–ª–∏ –¥–æ–±–∞–≤–∏—Ç—å –≤ —Å–∏–º–ø—Ç–æ–º—ã
    if "quick_pain" not in data:
        data["quick_pain"] = []
    data["quick_pain"].append(entry)
    save_data(data)
    
    await update.message.reply_text(f"ü¶¥ –ë–æ–ª—å –≤ –∫–æ–ø—á–∏–∫–µ: {level}/10 ‚Äî –∑–∞–ø–∏—Å–∞–Ω–æ.")

async def brain_fog(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–ö–æ–º–∞–Ω–¥–∞ /–º–æ–∑–≥ ‚Äî –∫–æ–≥–Ω–∏—Ç–∏–≤–Ω—ã–µ —Å–∏–º–ø—Ç–æ–º—ã."""
    keyboard = [
        [InlineKeyboardButton("üå´ –¢—É–º–∞–Ω", callback_data="cog_fog")],
        [InlineKeyboardButton("üåÄ –†–∞—Å—Å–µ—è–Ω–Ω–æ—Å—Ç—å", callback_data="cog_distraction")],
        [InlineKeyboardButton("üí§ –ó–∞–±—ã–≤—á–∏–≤–æ—Å—Ç—å", callback_data="cog_forget")],
        [InlineKeyboardButton("‚è≥ –ü—Ä–æ–∫—Ä–∞—Å—Ç–∏–Ω–∞—Ü–∏—è", callback_data="cog_procrast")],
        [InlineKeyboardButton("‚ùå –û—Ç–º–µ–Ω–∞", callback_data="cancel")]
    ]
    reply_markup = InlineKeyboardMarkup(keyboard)
    await update.message.reply_text(
        "üß† –ß—Ç–æ –∏–º–µ–Ω–Ω–æ –±–µ—Å–ø–æ–∫–æ–∏—Ç?",
        reply_markup=reply_markup
    )
    # –ó–¥–µ—Å—å –Ω—É–∂–µ–Ω –¥–∏–∞–ª–æ–≥ –¥–ª—è –≤—ã–±–æ—Ä–∞ –∏ –æ—Ü–µ–Ω–∫–∏, –Ω–æ –¥–ª—è –ø—Ä–æ—Å—Ç–æ—Ç—ã —Å—Ä–∞–∑—É —Å–æ—Ö—Ä–∞–Ω–∏–º
    # –í –¢–ó —Ç—Ä–µ–±—É–µ—Ç—Å—è –æ—Ü–µ–Ω–∫–∞ 0-5, –Ω–æ –¥–ª—è –±—ã—Å—Ç—Ä–æ—Ç—ã –º–æ–∂–µ–º —Å–ø—Ä–æ—Å–∏—Ç—å –ø–æ—Ç–æ–º
    # –£–ø—Ä–æ—Å—Ç–∏–º: –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–∂–∏–º–∞–µ—Ç –∫–Ω–æ–ø–∫—É, –∏ –º—ã –ø—Ä–æ—Å–∏–º –æ—Ü–µ–Ω–∫—É
    return  # TODO: —Ä–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –ø–æ–ª–Ω–æ—Ü–µ–Ω–Ω—ã–π –¥–∏–∞–ª–æ–≥, –µ—Å–ª–∏ –Ω—É–∂–Ω–æ

# –î–ª—è –ø—Ä–æ—Å—Ç–æ—Ç—ã MVP –º–æ–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å /–º–æ–∑–≥ –∫–∞–∫ –ø—Ä–æ—Å—Ç–æ –∑–∞–ø–∏—Å—å –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö —Å–∏–º–ø—Ç–æ–º–æ–≤ —Å –æ—Ü–µ–Ω–∫–æ–π —á–µ—Ä–µ–∑ –∏–Ω–ª–∞–π–Ω.
# –†–µ–∞–ª–∏–∑—É–µ–º —á–µ—Ä–µ–∑ ConversationHandler.
async def brain_start(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–ù–∞—á–∞–ª–æ –¥–∏–∞–ª–æ–≥–∞ –∫–æ–≥–Ω–∏—Ç–∏–≤–Ω—ã—Ö —Å–∏–º–ø—Ç–æ–º–æ–≤."""
    keyboard = [
        [InlineKeyboardButton("üå´ –¢—É–º–∞–Ω", callback_data="cog_fog")],
        [InlineKeyboardButton("üåÄ –†–∞—Å—Å–µ—è–Ω–Ω–æ—Å—Ç—å", callback_data="cog_distraction")],
        [InlineKeyboardButton("üí§ –ó–∞–±—ã–≤—á–∏–≤–æ—Å—Ç—å", callback_data="cog_forget")],
        [InlineKeyboardButton("‚è≥ –ü—Ä–æ–∫—Ä–∞—Å—Ç–∏–Ω–∞—Ü–∏—è", callback_data="cog_procrast")],
        [InlineKeyboardButton("‚úÖ –ì–æ—Ç–æ–≤–æ", callback_data="cog_done")]
    ]
    reply_markup = InlineKeyboardMarkup(keyboard)
    context.user_data["cog_symptoms"] = []
    await update.message.reply_text(
        "üß† –í—ã–±–µ—Ä–∏ —Å–∏–º–ø—Ç–æ–º—ã (–º–æ–∂–Ω–æ –Ω–µ—Å–∫–æ–ª—å–∫–æ), –∑–∞—Ç–µ–º –Ω–∞–∂–º–∏ ¬´–ì–æ—Ç–æ–≤–æ¬ª:",
        reply_markup=reply_markup
    )
    return 1  # —Å–æ—Å—Ç–æ—è–Ω–∏–µ –¥–ª—è —Å–±–æ—Ä–∞ —Å–∏–º–ø—Ç–æ–º–æ–≤

async def brain_collect(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–°–±–æ—Ä –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö –∫–æ–≥–Ω–∏—Ç–∏–≤–Ω—ã—Ö —Å–∏–º–ø—Ç–æ–º–æ–≤."""
    query = update.callback_query
    await query.answer()
    
    if query.data == "cog_done":
        if not context.user_data["cog_symptoms"]:
            await query.edit_message_text("‚ùå –ù–µ –≤—ã–±—Ä–∞–Ω –Ω–∏ –æ–¥–∏–Ω —Å–∏–º–ø—Ç–æ–º.")
            return ConversationHandler.END
        # –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –æ—Ü–µ–Ω–∫—É
        await query.edit_message_text(
            "üìä –û—Ü–µ–Ω–∏ –æ–±—â—É—é –∏–Ω—Ç–µ–Ω—Å–∏–≤–Ω–æ—Å—Ç—å –∫–æ–≥–Ω–∏—Ç–∏–≤–Ω—ã—Ö —Å–∏–º–ø—Ç–æ–º–æ–≤ —Å–µ–≥–æ–¥–Ω—è (0‚Äì5):"
        )
        return 2
    elif query.data.startswith("cog_"):
        symptom_map = {
            "cog_fog": "—Ç—É–º–∞–Ω",
            "cog_distraction": "—Ä–∞—Å—Å–µ—è–Ω–Ω–æ—Å—Ç—å",
            "cog_forget": "–∑–∞–±—ã–≤—á–∏–≤–æ—Å—Ç—å",
            "cog_procrast": "–ø—Ä–æ–∫—Ä–∞—Å—Ç–∏–Ω–∞—Ü–∏—è"
        }
        symptom = symptom_map.get(query.data, query.data)
        if symptom not in context.user_data["cog_symptoms"]:
            context.user_data["cog_symptoms"].append(symptom)
            await query.answer(f"‚úÖ {symptom} –¥–æ–±–∞–≤–ª–µ–Ω")
        else:
            await query.answer("–£–∂–µ –¥–æ–±–∞–≤–ª–µ–Ω–æ")
    return 1

async def brain_rating(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–ü–æ–ª—É—á–∞–µ–º –æ—Ü–µ–Ω–∫—É –∏ —Å–æ—Ö—Ä–∞–Ω—è–µ–º."""
    try:
        rating = int(update.message.text.strip())
        if rating < 0 or rating > 5:
            raise ValueError
    except:
        await update.message.reply_text("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏ —á–∏—Å–ª–æ –æ—Ç 0 –¥–æ 5.")
        return 2
    
    user_id = str(update.effective_user.id)
    data = load_data()
    
    entry = {
        "user_id": user_id,
        "date": datetime.now().isoformat(),
        "symptoms": context.user_data["cog_symptoms"],
        "rating": rating
    }
    data.setdefault("cognition", []).append(entry)
    save_data(data)
    
    await update.message.reply_text(
        f"‚úÖ –ö–æ–≥–Ω–∏—Ç–∏–≤–Ω—ã–µ —Å–∏–º–ø—Ç–æ–º—ã –∑–∞–ø–∏—Å–∞–Ω—ã: {', '.join(entry['symptoms'])} (–∏–Ω—Ç–µ–Ω—Å–∏–≤–Ω–æ—Å—Ç—å {rating}/5)"
    )
    context.user_data.clear()
    return ConversationHandler.END

# ================ –ö–û–ú–ê–ù–î–ê /–¢–†–ò–ì–ì–ï–† ================
async def add_trigger(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–ë—ã—Å—Ç—Ä–æ–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ —Ç—Ä–∏–≥–≥–µ—Ä–∞ (–±–µ–∑ –¥–∏–∞–ª–æ–≥–∞)."""
    # –ü—Ä–æ—Å—Ç–æ —Å–æ—Ö—Ä–∞–Ω–∏–º –∏–∑ —Ç–µ–∫—Å—Ç–∞ –ø–æ—Å–ª–µ –∫–æ–º–∞–Ω–¥—ã
    args = context.args
    if not args:
        await update.message.reply_text("–£–∫–∞–∂–∏ —Ç—Ä–∏–≥–≥–µ—Ä: /—Ç—Ä–∏–≥–≥–µ—Ä —Å—Ç—Ä–µ—Å—Å")
        return
    trigger_text = " ".join(args)
    
    user_id = str(update.effective_user.id)
    data = load_data()
    entry = {
        "user_id": user_id,
        "date": datetime.now().isoformat(),
        "trigger": trigger_text
    }
    data["triggers"].append(entry)
    save_data(data)
    
    await update.message.reply_text(f"‚úÖ –¢—Ä–∏–≥–≥–µ—Ä ¬´{trigger_text}¬ª –∑–∞–ø–∏—Å–∞–Ω.")

# ================ –ö–û–ú–ê–ù–î–ê /–õ–ï–ö–ê–†–°–¢–í–û ================
async def medication_start(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–î–∏–∞–ª–æ–≥ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –ø—Ä–∏—ë–º–∞ –ª–µ–∫–∞—Ä—Å—Ç–≤–∞."""
    await update.message.reply_text("üíä –ù–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–µ–ø–∞—Ä–∞—Ç–∞:")
    return STATE_MED_NAME

async def med_name(update: Update, context: ContextTypes.DEFAULT_TYPE):
    context.user_data["med_name"] = update.message.text.strip()
    await update.message.reply_text("‚öñ –î–æ–∑–∏—Ä–æ–≤–∫–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, 500 –º–≥):")
    return STATE_MED_DOSE

async def med_dose(update: Update, context: ContextTypes.DEFAULT_TYPE):
    dose = update.message.text.strip()
    user_id = str(update.effective_user.id)
    data = load_data()
    
    entry = {
        "user_id": user_id,
        "date": datetime.now().isoformat(),
        "med_name": context.user_data["med_name"],
        "dose": dose,
        "taken": True
    }
    data["medications"].append(entry)
    save_data(data)
    
    await update.message.reply_text(
        f"‚úÖ –ü—Ä–∏—ë–º {entry['med_name']} {entry['dose']} –∑–∞–ø–∏—Å–∞–Ω."
    )
    context.user_data.clear()
    return ConversationHandler.END

# ================ –ö–û–ú–ê–ù–î–ê /–ê–ù–ê–õ–ò–ó ================
async def analysis_start(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–ó–∞–≥—Ä—É–∑–∫–∞ –∞–Ω–∞–ª–∏–∑–∞ (—Ç–µ–∫—Å—Ç/—Ñ–æ—Ç–æ)."""
    await update.message.reply_text(
        "üìÑ –û—Ç–ø—Ä–∞–≤—å —Ç–µ–∫—Å—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ –∞–Ω–∞–ª–∏–∑–∞ –∏–ª–∏ –∑–∞–≥—Ä—É–∑–∏ —Ñ–æ—Ç–æ."
    )
    return STATE_ANALYSIS_TEXT

async def analysis_text(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–µ–∫—Å—Ç–æ–≤—ã–π –∞–Ω–∞–ª–∏–∑."""
    text = update.message.text
    user_id = str(update.effective_user.id)
    data = load_data()
    
    entry = {
        "user_id": user_id,
        "date": datetime.now().isoformat(),
        "type": "text",
        "content": text
    }
    data["analyses"].append(entry)
    save_data(data)
    
    await update.message.reply_text("‚úÖ –ê–Ω–∞–ª–∏–∑ —Å–æ—Ö—Ä–∞–Ω—ë–Ω.")
    return ConversationHandler.END

async def analysis_photo(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–°–æ—Ö—Ä–∞–Ω—è–µ–º —Ñ–æ—Ç–æ –∞–Ω–∞–ª–∏–∑–∞."""
    photo = update.message.photo[-1]  # —Å–∞–º–æ–µ –±–æ–ª—å—à–æ–µ
    file_id = photo.file_id
    user_id = str(update.effective_user.id)
    data = load_data()
    
    entry = {
        "user_id": user_id,
        "date": datetime.now().isoformat(),
        "type": "photo",
        "file_id": file_id
    }
    data["analyses"].append(entry)
    save_data(data)
    
    await update.message.reply_text("‚úÖ –§–æ—Ç–æ –∞–Ω–∞–ª–∏–∑–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ.")
    return ConversationHandler.END

# ================ –ï–ñ–ï–î–ù–ï–í–ù–´–ô –ß–ï–ö-–ò–ù ================
async def daily_checkin(context: ContextTypes.DEFAULT_TYPE):
    """–§—É–Ω–∫—Ü–∏—è, –≤—ã–∑—ã–≤–∞–µ–º–∞—è –∫–∞–∂–¥—ã–π –¥–µ–Ω—å –≤ 21:00."""
    # –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
    data = load_data()
    user_ids = data["users"].keys()
    
    for uid in user_ids:
        try:
            keyboard = [
                [InlineKeyboardButton("0Ô∏è‚É£", callback_data="pain_0"),
                 InlineKeyboardButton("1Ô∏è‚É£", callback_data="pain_1"),
                 InlineKeyboardButton("2Ô∏è‚É£", callback_data="pain_2"),
                 InlineKeyboardButton("3Ô∏è‚É£", callback_data="pain_3")],
                [InlineKeyboardButton("4Ô∏è‚É£", callback_data="pain_4"),
                 InlineKeyboardButton("5Ô∏è‚É£", callback_data="pain_5"),
                 InlineKeyboardButton("6Ô∏è‚É£", callback_data="pain_6"),
                 InlineKeyboardButton("7Ô∏è‚É£", callback_data="pain_7")],
                [InlineKeyboardButton("8Ô∏è‚É£", callback_data="pain_8"),
                 InlineKeyboardButton("9Ô∏è‚É£", callback_data="pain_9"),
                 InlineKeyboardButton("üîü", callback_data="pain_10")]
            ]
            markup = InlineKeyboardMarkup(keyboard)
            await context.bot.send_message(
                chat_id=uid,
                text="üåô *–í–µ—á–µ—Ä–Ω–∏–π —á–µ–∫-–∏–Ω*\n\n–û—Ü–µ–Ω–∏ –±–æ–ª—å –≤ –∫–æ–ø—á–∏–∫–µ –∑–∞ —Å–µ–≥–æ–¥–Ω—è (0‚Äì10):",
                parse_mode=ParseMode.MARKDOWN,
                reply_markup=markup
            )
            # –ó–¥–µ—Å—å –ø—Ä–æ–¥–æ–ª–∂–∏–º –¥–∏–∞–ª–æ–≥: –ø–æ—Å–ª–µ –±–æ–ª–∏ —Å–ø—Ä–æ—Å–∏–º —Ç—É–º–∞–Ω –∏ —Å–æ–Ω.
            # –î–ª—è –ø—Ä–æ—Å—Ç–æ—Ç—ã –≤ –∫–æ–ª–±—ç–∫–∞—Ö –æ–±—Ä–∞–±–æ—Ç–∞–µ–º –ø–æ—à–∞–≥–æ–≤–æ.
        except Exception as e:
            logger.error(f"–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —á–µ–∫-–∏–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é {uid}: {e}")

async def checkin_callback(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ç–≤–µ—Ç–æ–≤ –Ω–∞ —á–µ–∫-–∏–Ω."""
    query = update.callback_query
    await query.answer()
    
    user_id = str(update.effective_user.id)
    data = load_data()
    
    if query.data.startswith("pain_"):
        pain = int(query.data.split("_")[1])
        context.user_data["checkin_pain"] = pain
        # –ó–∞–ø—Ä–æ—Å —Ç—É–º–∞–Ω–∞
        keyboard = [
            [InlineKeyboardButton("0", callback_data="fog_0"),
             InlineKeyboardButton("1", callback_data="fog_1"),
             InlineKeyboardButton("2", callback_data="fog_2")],
            [InlineKeyboardButton("3", callback_data="fog_3"),
             InlineKeyboardButton("4", callback_data="fog_4"),
             InlineKeyboardButton("5", callback_data="fog_5")]
        ]
        markup = InlineKeyboardMarkup(keyboard)
        await query.edit_message_text(
            "üå´ –û—Ü–µ–Ω–∏ —Ç—É–º–∞–Ω –≤ –≥–æ–ª–æ–≤–µ (0‚Äì5):",
            reply_markup=markup
        )
    elif query.data.startswith("fog_"):
        fog = int(query.data.split("_")[1])
        context.user_data["checkin_fog"] = fog
        # –ó–∞–ø—Ä–æ—Å —Ä–∞—Å—Å–µ—è–Ω–Ω–æ—Å—Ç–∏/–∑–∞–±—ã–≤—á–∏–≤–æ—Å—Ç–∏
        keyboard = [
            [InlineKeyboardButton("0", callback_data="distr_0"),
             InlineKeyboardButton("1", callback_data="distr_1"),
             InlineKeyboardButton("2", callback_data="distr_2")],
            [InlineKeyboardButton("3", callback_data="distr_3"),
             InlineKeyboardButton("4", callback_data="distr_4"),
             InlineKeyboardButton("5", callback_data="distr_5")]
        ]
        markup = InlineKeyboardMarkup(keyboard)
        await query.edit_message_text(
            "üåÄ –û—Ü–µ–Ω–∏ —Ä–∞—Å—Å–µ—è–Ω–Ω–æ—Å—Ç—å / –∑–∞–±—ã–≤—á–∏–≤–æ—Å—Ç—å (0‚Äì5):",
            reply_markup=markup
        )
    elif query.data.startswith("distr_"):
        distraction = int(query.data.split("_")[1])
        context.user_data["checkin_distraction"] = distraction
        # –ó–∞–ø—Ä–æ—Å –∫–∞—á–µ—Å—Ç–≤–∞ —Å–Ω–∞
        keyboard = [
            [InlineKeyboardButton("üò¥ –û—Ç–ª–∏—á–Ω–æ", callback_data="sleep_good")],
            [InlineKeyboardButton("üü° –°—Ä–µ–¥–Ω–µ", callback_data="sleep_mid")],
            [InlineKeyboardButton("üî¥ –ü–ª–æ—Ö–æ", callback_data="sleep_bad")]
        ]
        markup = InlineKeyboardMarkup(keyboard)
        await query.edit_message_text(
            "üí§ –ö–∞–∫ —Å–ø–∞–ª–æ—Å—å –ø—Ä–æ—à–ª–æ–π –Ω–æ—á—å—é?",
            reply_markup=markup
        )
    elif query.data.startswith("sleep_"):
        sleep_map = {"good": "üò¥ –æ—Ç–ª–∏—á–Ω–æ", "mid": "üü° —Å—Ä–µ–¥–Ω–µ", "bad": "üî¥ –ø–ª–æ—Ö–æ"}
        sleep = sleep_map.get(query.data.split("_")[1], "–Ω–µ —É–∫–∞–∑–∞–Ω–æ")
        # –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤—Å–µ
        entry = {
            "user_id": user_id,
            "date": datetime.now().strftime("%Y-%m-%d"),
            "pain": context.user_data.get("checkin_pain"),
            "fog": context.user_data.get("checkin_fog"),
            "distraction": context.user_data.get("checkin_distraction"),
            "sleep": sleep
        }
        data.setdefault("symptoms", []).append(entry)
        save_data(data)
        
        await query.edit_message_text(
            "‚úÖ –ß–µ–∫-–∏–Ω –∑–∞–≤–µ—Ä—à—ë–Ω. –°–ø–æ–∫–æ–π–Ω–æ–π –Ω–æ—á–∏! üåô"
        )
        context.user_data.clear()

# ================ –ö–û–ú–ê–ù–î–ê /–û–¢–ß–Å–¢ ================
async def report(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–§–æ—Ä–º–∏—Ä—É–µ—Ç –æ—Ç—á—ë—Ç –∑–∞ –Ω–µ–¥–µ–ª—é/–º–µ—Å—è—Ü."""
    args = context.args
    period = "week" if not args or args[0] not in ["–º–µ—Å—è—Ü", "month"] else "month"
    
    user_id = str(update.effective_user.id)
    data = load_data()
    
    now = datetime.now()
    if period == "week":
        start_date = now - timedelta(days=7)
        period_name = "–Ω–µ–¥–µ–ª—é"
    else:
        start_date = now - timedelta(days=30)
        period_name = "–º–µ—Å—è—Ü"
    
    # –§–∏–ª—å—Ç—Ä—É–µ–º –∑–∞–ø–∏—Å–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∑–∞ –ø–µ—Ä–∏–æ–¥
    user_herpes = [h for h in data.get("herpes", [])
                   if h["user_id"] == user_id and datetime.fromisoformat(h["date"]) >= start_date]
    user_pain = [p for p in data.get("quick_pain", [])
                 if p["user_id"] == user_id and datetime.fromisoformat(p["date"]) >= start_date]
    user_cognition = [c for c in data.get("cognition", [])
                      if c["user_id"] == user_id and datetime.fromisoformat(c["date"]) >= start_date]
    user_triggers = [t for t in data.get("triggers", [])
                     if t["user_id"] == user_id and datetime.fromisoformat(t["date"]) >= start_date]
    user_precursors = [p for p in data.get("precursors", [])
                       if p["user_id"] == user_id and datetime.fromisoformat(p["date"]) >= start_date]
    
    # –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
    rec_count = len(user_herpes)
    avg_pain = 0
    if user_pain:
        avg_pain = sum(p["value"] for p in user_pain) / len(user_pain)
    fog_days = len([c for c in user_cognition if "—Ç—É–º–∞–Ω" in c["symptoms"] and c["rating"] > 0])
    
    # –¢–æ–ø-3 —Ç—Ä–∏–≥–≥–µ—Ä–∞
    trigger_list = [t["trigger"] for t in user_triggers if t.get("trigger")]
    trigger_counter = defaultdict(int)
    for t in trigger_list:
        trigger_counter[t] += 1
    top_triggers = sorted(trigger_counter.items(), key=lambda x: x[1], reverse=True)[:3]
    top_triggers_str = ", ".join([f"{t} ({c})" for t, c in top_triggers]) if top_triggers else "–Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö"
    
    # –ü—É–ª—å—Å-—Ç–µ—Ä–∞–ø–∏—è
    pulse_count = len([p for p in user_precursors if p.get("pulse_started")])
    
    report_text = (
        f"üìã *–û—Ç—á—ë—Ç –∑–∞ {period_name}*\n"
        f"({start_date.strftime('%d.%m.%Y')} ‚Äì {now.strftime('%d.%m.%Y')})\n\n"
        f"üîπ *–†–µ—Ü–∏–¥–∏–≤–æ–≤ –≥–µ—Ä–ø–µ—Å–∞*: {rec_count}\n"
        f"üîπ *–°—Ä–µ–¥–Ω—è—è –±–æ–ª—å –≤ –∫–æ–ø—á–∏–∫–µ*: {avg_pain:.1f}/10\n"
        f"üîπ *–î–Ω–∏ —Å —Ç—É–º–∞–Ω–æ–º*: {fog_days}\n"
        f"üîπ *–¢–æ–ø-3 —Ç—Ä–∏–≥–≥–µ—Ä–∞*: {top_triggers_str}\n"
        f"üîπ *–ü—É–ª—å—Å-—Ç–µ—Ä–∞–ø–∏—è*: –∑–∞–ø—É—â–µ–Ω–∞ {pulse_count} —Ä–∞–∑\n\n"
        f"_–î–∞–Ω–Ω—ã–µ –ø—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω—ã–µ, –º–æ–≥—É—Ç –±—ã—Ç—å –¥–æ–ø–æ–ª–Ω–µ–Ω—ã._"
    )
    
    await update.message.reply_text(report_text, parse_mode=ParseMode.MARKDOWN)

# ================ –ù–ê–ü–û–ú–ò–ù–ê–ù–ò–Ø (–£–ü–†–û–©–Å–ù–ù–û) ================
async def reminders(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π –æ –ª–µ–∫–∞—Ä—Å—Ç–≤–∞—Ö."""
    # –ü–æ–∫–∞ –ø—Ä–æ—Å—Ç–æ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
    await update.message.reply_text(
        "üîî –§—É–Ω–∫—Ü–∏—è –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ.\n"
        "–ü–æ–∫–∞ –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å —Å–µ–±–µ –±—É–¥–∏–ª—å–Ω–∏–∫ –≤ —Ç–µ–ª–µ—Ñ–æ–Ω–µ."
    )
    # TODO: –ø–æ–ª–Ω–æ—Ü–µ–Ω–Ω—ã–π –¥–∏–∞–ª–æ–≥ —Å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º –≤ data["users"][user_id]["reminders"] –∏ JobQueue

# ================ –û–¢–ú–ï–ù–ê –î–ò–ê–õ–û–ì–û–í ================
async def cancel(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–û—Ç–º–µ–Ω–∞ –ª—é–±–æ–≥–æ –¥–∏–∞–ª–æ–≥–∞."""
    await update.message.reply_text("‚ùå –î–µ–π—Å—Ç–≤–∏–µ –æ—Ç–º–µ–Ω–µ–Ω–æ.", reply_markup=ReplyKeyboardRemove())
    context.user_data.clear()
    return ConversationHandler.END

# ================ –ó–ê–ü–£–°–ö –ü–õ–ê–ù–ò–†–û–í–©–ò–ö–ê ================
async def post_init(application: Application):
    """–î–µ–π—Å—Ç–≤–∏—è –ø–æ—Å–ª–µ —Å—Ç–∞—Ä—Ç–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è: —É—Å—Ç–∞–Ω–æ–≤–∫–∞ –µ–∂–µ–¥–Ω–µ–≤–Ω–æ–π –∑–∞–¥–∞—á–∏."""
    # –ó–∞–ø—É—Å–∫–∞–µ–º –µ–∂–µ–¥–Ω–µ–≤–Ω—ã–π —á–µ–∫-–∏–Ω –≤ 21:00 –ø–æ –º–µ—Å—Ç–Ω–æ–º—É –≤—Ä–µ–º–µ–Ω–∏ (UTC+3)
    job_queue = application.job_queue
    job_queue.run_daily(
        daily_checkin,
        time=datetime.strptime(CHECKIN_TIME, "%H:%M").time(),
        days=tuple(range(7))
    )
    logger.info(f"–ï–∂–µ–¥–Ω–µ–≤–Ω—ã–π —á–µ–∫-–∏–Ω —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –Ω–∞ {CHECKIN_TIME} (UTC+{TIMEZONE_OFFSET})")

# ================ MAIN ================
def main():
    # –°–æ–∑–¥–∞—ë–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
    application = Application.builder().token(TOKEN).post_init(post_init).build()
    
    # --- –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –ø—Ä–æ—Å—Ç—ã—Ö –∫–æ–º–∞–Ω–¥ ---
    application.add_handler(CommandHandler("start", start))
    application.add_handler(CommandHandler("help", help_command))
    application.add_handler(CommandHandler("–±–æ–ª—å", quick_pain))
    application.add_handler(CommandHandler("—Ç—Ä–∏–≥–≥–µ—Ä", add_trigger))
    application.add_handler(CommandHandler("–æ—Ç—á—ë—Ç", report))
    application.add_handler(CommandHandler("cancel", cancel))
    
    # --- –î–∏–∞–ª–æ–≥ /–≥–µ—Ä–ø–µ—Å ---
    herpes_conv = ConversationHandler(
        entry_points=[CommandHandler("–≥–µ—Ä–ø–µ—Å", herpes_start)],
        states={
            STATE_HERPES_LOCATION: [CallbackQueryHandler(herpes_location)],
            STATE_HERPES_INTENSITY: [CallbackQueryHandler(herpes_intensity)],
            STATE_HERPES_TRIGGER: [CallbackQueryHandler(herpes_trigger)],
            STATE_HERPES_NOTES: [
                MessageHandler(filters.TEXT & ~filters.COMMAND, herpes_notes),
                CommandHandler("skip", herpes_notes_skip)
            ],
        },
        fallbacks=[CommandHandler("cancel", cancel)],
        allow_reentry=True
    )
    application.add_handler(herpes_conv)
    
    # --- –î–∏–∞–ª–æ–≥ /–ø—Ä–µ–¥ ---
    precursor_conv = ConversationHandler(
        entry_points=[CommandHandler("–ø—Ä–µ–¥", precursor_start)],
        states={
            STATE_PRECURSOR_DESC: [
                MessageHandler(filters.TEXT & ~filters.COMMAND, precursor_desc),
                CallbackQueryHandler(precursor_callback)
            ],
        },
        fallbacks=[CommandHandler("cancel", cancel)],
        allow_reentry=True
    )
    application.add_handler(precursor_conv)
    
    # --- –î–∏–∞–ª–æ–≥ /–º–æ–∑–≥ ---
    brain_conv = ConversationHandler(
        entry_points=[CommandHandler("–º–æ–∑–≥", brain_start)],
        states={
            1: [CallbackQueryHandler(brain_collect)],
            2: [MessageHandler(filters.TEXT & ~filters.COMMAND, brain_rating)]
        },
        fallbacks=[CommandHandler("cancel", cancel)],
        allow_reentry=True
    )
    application.add_handler(brain_conv)
    
    # --- –î–∏–∞–ª–æ–≥ /–ª–µ–∫–∞—Ä—Å—Ç–≤–æ ---
    med_conv = ConversationHandler(
        entry_points=[CommandHandler("–ª–µ–∫–∞—Ä—Å—Ç–≤–æ", medication_start)],
        states={
            STATE_MED_NAME: [MessageHandler(filters.TEXT & ~filters.COMMAND, med_name)],
            STATE_MED_DOSE: [MessageHandler(filters.TEXT & ~filters.COMMAND, med_dose)],
        },
        fallbacks=[CommandHandler("cancel", cancel)],
        allow_reentry=True
    )
    application.add_handler(med_conv)
    
    # --- –î–∏–∞–ª–æ–≥ /–∞–Ω–∞–ª–∏–∑ ---
    analysis_conv = ConversationHandler(
        entry_points=[CommandHandler("–∞–Ω–∞–ª–∏–∑", analysis_start)],
        states={
            STATE_ANALYSIS_TEXT: [
                MessageHandler(filters.TEXT & ~filters.COMMAND, analysis_text),
                MessageHandler(filters.PHOTO, analysis_photo)
            ],
        },
        fallbacks=[CommandHandler("cancel", cancel)],
        allow_reentry=True
    )
    application.add_handler(analysis_conv)
    
    # --- –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–ª–±—ç–∫–æ–≤ —á–µ–∫-–∏–Ω–∞ ---
    application.add_handler(CallbackQueryHandler(checkin_callback, pattern="^(pain|fog|distr|sleep)_"))
    
    # –ó–∞–ø—É—Å–∫
    logger.info("–ë–æ—Ç GeroHealthBot –∑–∞–ø—É—â–µ–Ω –∏ –∂–¥—ë—Ç –∫–æ–º–∞–Ω–¥—ã...")
    application.run_polling(allowed_updates=Update.ALL_TYPES)

if __name__ == "__main__":
    main()
